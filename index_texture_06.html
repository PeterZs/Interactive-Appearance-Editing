<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - custom attributes</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
				z-index:100;
			}
		</style>
	</head>

	<body>

		<div id="container"></div>

        <script src="build/three.js"></script>
        <script src="js/controls/OrbitControls.js"></script>
        <script src="js/Detector.js"></script>
        <script src="js/libs/stats.min.js"></script>
        <script src="js/libs/dat.gui.min.js"></script>

		<script id="vertex_shader" type="x-shader/x-vertex">

		varying vec2 vUv;
		varying vec3 vNormal;
		varying vec3 vViewPosition;

		void main() {

			vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

			vUv = uv;
			vNormal = normalize( normalMatrix * normal );
			vViewPosition = -mvPosition.xyz;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}

		</script>

		<script id="fragment_shader" type="x-shader/x-fragment">

		uniform sampler2D texture;
		uniform sampler2D texture2;
		uniform vec3 color;
		varying vec2 vUv;
		varying vec3 vNormal;
		varying vec3 vViewPosition;

		void main() {
		vec4 tc = vec4(color.r, color.g, color.b, 1.0 );
			vec4 tColor = texture2D( texture, vUv );
			vec4 tColor2 = texture2D( texture2, vUv );

			// hack in a fake pointlight at camera location, plus ambient
			vec3 normal = normalize( vNormal );
			vec3 lightDir = normalize( vViewPosition );

			float dotProduct = max( dot( normal, lightDir ), 0.0 ) + 0.2;

		    //gl_FragColor = vec4( mix( tColor.rgb, tColor2.rgb, tColor2.a ), 1.0 ) * dotProduct;
		    
		    vec4 mix_c = tColor2 + tc * tColor2.a;
		    //gl_FragColor = vec4( mix( tColor.rgb, mix_c.xyz, tColor2.a ), 1.0 ) * dotProduct;

		    gl_FragColor = tColor2 + tColor;

		}

		</script>




		<script>
		// three.js Custom ShaderMaterial with Multiple Textures

		var mesh, renderer, scene, camera, controls;

		init();
		animate();

		function init() {

			// info
			info = document.createElement( 'div' );
			info.style.position = 'absolute';
			info.style.top = '30px';
			info.style.width = '100%';
			info.style.textAlign = 'center';
			info.style.color = '#fff';
			info.style.fontWeight = 'bold';
			info.style.backgroundColor = 'transparent';
			info.style.zIndex = '1';
			info.style.fontFamily = 'Monospace';
			info.innerHTML = 'Drag mouse to rotate camera; scroll to zoom';
			document.body.appendChild( info );

			// renderer
			renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			// scene
			scene = new THREE.Scene();
			
			// camera
			camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 1000 );
			camera.position.set( 200, 0, 200 );

			// controls
			controls = new THREE.OrbitControls( camera, renderer.domElement );

			// no lights in this example; fake them in the shader
			
			// cube geometry
			var geometry = new THREE.BoxGeometry( 70, 70, 70 );

			// texture
			//var texture = new THREE.Texture( generateTexture( ) );
			var texture = new THREE.TextureLoader().load( "assets/textures/UV_Grid_Sm.jpg" )
			texture.needsUpdate = true; // important
			//var texture2 = new THREE.Texture( generateTexture2( ) ); // texture background is transparent
			var texture2 = new THREE.TextureLoader().load( "assets/textures/brick_diffuse.jpg" )
			texture2.needsUpdate = true; // important

			// uniforms
			var uniforms = {
		    color: { type: "c", value: new THREE.Color( 0x0000ff ) },
				texture: { type: "t", value: texture },
				texture2: { type: "t", value: texture2 }
			};

			// attributes
			var attributes = {
			};

			// material
			var material = new THREE.ShaderMaterial({
				attributes      : attributes,
				uniforms        : uniforms,
				vertexShader    : document.getElementById( 'vertex_shader' ).textContent,
				fragmentShader  : document.getElementById( 'fragment_shader' ).textContent
			});
		    
			// cube
			mesh = new THREE.Mesh( geometry, material );
			scene.add( mesh );

		}

		function animate() {

			requestAnimationFrame( animate );
		    
			controls.update();

		    mesh.rotation.x += 0.001;
		    mesh.rotation.y += 0.002;
		    mesh.rotation.z += 0.003;

			renderer.render( scene, camera );

		}

		// Utility
		// ---------------------------------------------------------------------------------

		function generateTexture2() {

			// draw a circle in the center of the canvas
			var size = 256;

			// create canvas
			var canvas = document.createElement( 'canvas' );
			canvas.width = size;
			canvas.height = size;

			// get context
			var context = canvas.getContext( '2d' );

			// draw background
			context.fillStyle = "rgba( 0, 0, 0, 0.0 )";
			context.fillRect( 0, 0, size, size );

			// draw circle
			var centerX = size / 2;
			var centerY = size / 2;
			var radius = size / 4;

			context.beginPath();
			context.arc( centerX, centerY, radius, 0, 2 * Math.PI, false );
			context.fillStyle = "rgba( 0, 0, 0, 1 )";
			context.fill();
			//context.lineWidth = 10;
			//context.strokeStyle = "red";
			//context.stroke();

			return canvas;

		}

		function generateTexture() {

			// draw a circle in the center of the canvas
			var size = 256;

			// create canvas
			var canvas = document.createElement( 'canvas' );
			canvas.width = size;
			canvas.height = size;

			// get context
			var context = canvas.getContext( '2d' );

			// draw background
			context.fillStyle = "rgba( 255, 204, 102, 1 )";
			context.fillRect( 0, 0, size, size );

			// draw circle
			var centerX = size / 2;
			var centerY = size / 2;
			var radius = size / 3;

			context.beginPath();
			context.arc( centerX, centerY, radius, 0, 2 * Math.PI, false );
			context.lineWidth = 10;
			context.strokeStyle = "red";
			context.stroke();

			return canvas;

		}		

		</script>

</body>

</html>